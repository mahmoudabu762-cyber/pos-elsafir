<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ - Ø§Ù„Ø´Ø±ÙŠÙ</title>
 
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: "Cairo", sans-serif;
      background: linear-gradient(135deg, #007bff, #00c6ff);
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .login-card {
      background: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 0 20px rgba(0,0,0,0.2);
      width: 100%;
      max-width: 400px;
      text-align: center;
    }
    h2 {
      margin-bottom: 20px;
      color: #007bff;
    }
    input, select {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      box-sizing: border-box;
      border: 1px solid #ccc;
      border-radius: 5px;
    }
    button {
      margin: 10px 0;
      padding: 10px;
      font-size: 16px;
      width: 100%;
      background: #007bff;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      transition: background 0.3s;
    }
    button:hover {
      background: #0056b3;
    }
    #error, #modalError {
      color: red;
      font-weight: bold;
      min-height: 24px;
      margin-top: 10px;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0,0,0,0.5);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: white;
      padding: 20px;
      border-radius: 10px;
      width: 90%;
      max-width: 500px;
      max-height: 90vh;
      overflow-y: auto;
    }
    .close-btn {
      background: red;
      color: white;
      border: none;
      padding: 5px 10px;
      float: left;
      margin-bottom: 10px;
      border-radius: 5px;
      cursor: pointer;
    }
    .user-box {
      border: 1px solid #ccc;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      text-align: left;
    }
  </style>
</head>
<body>
   
  <div class="login-card">
    
    <h2>ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h2>
    <input type="email" id="email" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
    <input type="password" id="password" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
    <button id="loginBtn">Ø¯Ø®ÙˆÙ„</button>
    <button id="openModalBtn">ØªØ³Ø¬ÙŠÙ„ Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</button>
    <p id="error"></p>
    
  </div>

  <div class="modal" id="userModal">
    <div class="modal-content">
      <button class="close-btn" id="closeModalBtn">Ø¥ØºÙ„Ø§Ù‚</button>
      <h3>Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªØ®Ø¯Ù… Ø¬Ø¯ÙŠØ¯</h3>
      <input type="text" id="newName" placeholder="Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„" />
      <input type="email" id="newEmail" placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ" />
      <input type="password" id="newPassword" placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±" />
      <select id="newRole">
        <option value="">Ø§Ø®ØªØ± Ø§Ù„Ø¯ÙˆØ±</option>
        <option value="ÙƒØ§Ø´ÙŠØ±">ÙƒØ§Ø´ÙŠØ±</option>
        <option value="Ù…Ø¯ÙŠØ±">Ù…Ø¯ÙŠØ±</option>
      </select>
      <input type="text" id="newBranch" placeholder="Ø§Ø³Ù… Ø§Ù„ÙØ±Ø¹ Ø£Ùˆ Ø§Ù„Ù…Ø®Ø²Ù†" />
      <input type="password" id="adminKey" placeholder="ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± (1989)" />
      <button id="addUserBtn">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</button>
      <p id="modalError"></p>
      <hr>
      <h3>ğŸ“‹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙˆÙ† Ø§Ù„Ù…Ø³Ø¬Ù„ÙˆÙ†:</h3>
      <div id="userList"></div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, deleteUser } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-auth.js";
    import { getFirestore, setDoc, doc, getDoc, collection, getDocs, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.5.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAwafvR_SA8v_tsA_B0YhknMqlytMNUCQk",
      authDomain: "pos-bahaa.firebaseapp.com",
      projectId: "pos-bahaa",
      storageBucket: "pos-bahaa.appspot.com",
      messagingSenderId: "898451030919",
      appId: "1:898451030919:web:822b019b0b038081470922"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const emailInput = document.getElementById("email");
    const passwordInput = document.getElementById("password");
    const loginBtn = document.getElementById("loginBtn");
    const errorMsg = document.getElementById("error");

    const openModalBtn = document.getElementById("openModalBtn");
    const closeModalBtn = document.getElementById("closeModalBtn");
    const userModal = document.getElementById("userModal");

    const newName = document.getElementById("newName");
    const newEmail = document.getElementById("newEmail");
    const newPassword = document.getElementById("newPassword");
    const newRole = document.getElementById("newRole");
    const newBranch = document.getElementById("newBranch");
    const adminKey = document.getElementById("adminKey");
    const addUserBtn = document.getElementById("addUserBtn");
    const modalError = document.getElementById("modalError");
    const userList = document.getElementById("userList");

    loginBtn.onclick = async () => {
      errorMsg.textContent = "";
      const email = emailInput.value.trim();
      const password = passwordInput.value.trim();
      if (!email || !password) {
        errorMsg.textContent = "âš ï¸ Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø£ÙˆÙ„Ø§Ù‹.";
        return;
      }

      try {
        const result = await signInWithEmailAndPassword(auth, email, password);
        const uid = result.user.uid;
        const userDoc = await getDoc(doc(db, "users", uid));
        if (userDoc.exists()) {
          const data = userDoc.data();
          if (data.active === false) {
            errorMsg.textContent = "ğŸš« Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù†Ø´Ø·.";
            return;
          }
          localStorage.setItem("userName", data.name);
          localStorage.setItem("userEmail", data.email);
          localStorage.setItem("userRole", data.role);
          localStorage.setItem("userBranch", data.branch);
         window.location.href = data.role === "Ù…Ø¯ÙŠØ±" ? "pos.html" : "home.html";


          errorMsg.textContent = "âŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ØµÙ„Ø§Ø­ÙŠØ§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù….";
        }
      } catch (err) {
        errorMsg.textContent = "âŒ ÙØ´Ù„ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: " + err.message;
      }
    };

    openModalBtn.onclick = () => {
      const key = prompt("ğŸ” Ø£Ø¯Ø®Ù„ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ±:");
      if (key !== "1989") {
        alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© ØºÙŠØ± ØµØ­ÙŠØ­Ø©.");
        return;
      }
      userModal.style.display = "flex";
      loadUsers();
    };

    closeModalBtn.onclick = () => {
      userModal.style.display = "none";
      modalError.textContent = "";
    };

    addUserBtn.onclick = async () => {
      modalError.textContent = "";

      const name = newName.value.trim();
      const email = newEmail.value.trim();
      const password = newPassword.value.trim();
      const role = newRole.value;
      const branch = newBranch.value.trim();
      const key = adminKey.value.trim();

            if (key !== "1989") {
        modalError.textContent = "âŒ ÙƒÙ„Ù…Ø© Ù…Ø±ÙˆØ± Ø§Ù„Ù…Ø¯ÙŠØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return;
      }

      if (!name || !email || !password || !role || !branch) {
        modalError.textContent = "âš ï¸ ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ø¯Ø®Ø§Ù„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.";
        return;
      }

      if (!email.includes("@") || !email.includes(".")) {
        modalError.textContent = "âŒ ØµÙŠØºØ© Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ ØºÙŠØ± ØµØ­ÙŠØ­Ø©.";
        return;
      }

      if (password.length < 6) {
        modalError.textContent = "âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¶Ø¹ÙŠÙØ©. Ø§Ø³ØªØ®Ø¯Ù… 6 Ø£Ø­Ø±Ù Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.";
        return;
      }

      const snapshot = await getDocs(collection(db, "users"));
      const exists = snapshot.docs.some(doc => doc.data().email === email);
      if (exists) {
        modalError.textContent = "âŒ Ù‡Ø°Ø§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ù…Ø³Ø¬Ù„ Ø¨Ø§Ù„ÙØ¹Ù„.";
        return;
      }

      try {
        const result = await createUserWithEmailAndPassword(auth, email, password);
        const uid = result.user.uid;
        await setDoc(doc(db, "users", uid), {
          name,
          email,
          role,
          branch,
          active: true
        });
        modalError.textContent = "âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­.";
        newName.value = "";
        newEmail.value = "";
        newPassword.value = "";
        newRole.value = "";
        newBranch.value = "";
        adminKey.value = "";
        loadUsers();
      } catch (err) {
        modalError.textContent = "âŒ ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: " + err.message;
      }
    };

    async function loadUsers() {
      userList.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†...";
      const snapshot = await getDocs(collection(db, "users"));
      userList.innerHTML = "";
      snapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "user-box";
        div.innerHTML = `
          ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: <strong>${data.name}</strong><br>
          ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${data.email}<br>
          ğŸ§‘â€ğŸ’¼ Ø§Ù„Ø¯ÙˆØ±: <span id="role-${docSnap.id}">${data.role}</span><br>
          ğŸ¬ Ø§Ù„ÙØ±Ø¹: ${data.branch}<br>
          ğŸ”˜ Ø§Ù„Ø­Ø§Ù„Ø©: <span id="status-${docSnap.id}">${data.active === false ? "ØºÙŠØ± Ù†Ø´Ø·" : "Ù†Ø´Ø·"}</span><br>
          <button onclick="editUser('${docSnap.id}', '${data.name}', '${data.email}', '${data.role}', '${data.branch}')">âœï¸ ØªØ¹Ø¯ÙŠÙ„</button>
          <button onclick="deactivateUser('${docSnap.id}')">ğŸš« ØªØ¹Ø·ÙŠÙ„</button>
          ${data.active === false ? `<button onclick="activateUser('${docSnap.id}')">ğŸ”“ ØªÙØ¹ÙŠÙ„</button>` : ""}
          <button onclick="deleteUserFull('${docSnap.id}', '${data.email}')">ğŸ—‘ Ø­Ø°Ù</button>
        `;
        userList.appendChild(div);
      });
    }

    window.editUser = (id, name, email, role, branch) => {
      const newName = prompt("ğŸ‘¤ Ø§Ù„Ø§Ø³Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯:", name);
      const newEmail = prompt("ğŸ“§ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", email);
      const newRole = prompt("ğŸ§‘â€ğŸ’¼ Ø§Ù„Ø¯ÙˆØ± Ø§Ù„Ø¬Ø¯ÙŠØ¯:", role);
      const newBranch = prompt("ğŸ¬ Ø§Ù„ÙØ±Ø¹ Ø§Ù„Ø¬Ø¯ÙŠØ¯:", branch);
      if (newName && newEmail && newRole && newBranch) {
        updateDoc(doc(db, "users", id), {
          name: newName,
          email: newEmail,
          role: newRole,
          branch: newBranch
        }).then(() => {
          alert("âœ… ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­");
          loadUsers();
        });
      }
    };

    window.deactivateUser = async (id) => {
      await updateDoc(doc(db, "users", id), {
        active: false
      });
      document.getElementById(`status-${id}`).textContent = "ØºÙŠØ± Ù†Ø´Ø·";
      alert("ğŸš« ØªÙ… ØªØ¹Ø·ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
    };

    window.activateUser = async (id) => {
      await updateDoc(doc(db, "users", id), {
        active: true
      });
      document.getElementById(`status-${id}`).textContent = "Ù†Ø´Ø·";
      alert("âœ… ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
      loadUsers();
    };

    window.deleteUserFull = async (id, email) => {
      if (!confirm("âš ï¸ Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø°Ù Ù‡Ø°Ø§ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù†Ù‡Ø§Ø¦ÙŠÙ‹Ø§ØŸ")) return;

      try {
        await deleteDoc(doc(db, "users", id));
        const currentUser = auth.currentUser;
        if (currentUser && currentUser.email === email) {
          await deleteUser(currentUser);
          alert("ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore Ùˆ Authentication");
        } else {
          alert("ğŸ—‘ ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ù† Firestore ÙÙ‚Ø·.");
        }
        loadUsers();
      } catch (err) {
        alert("âŒ ÙØ´Ù„ Ø§Ù„Ø­Ø°Ù: " + err.message);
      }
    };
  </script>
</body>
</html>


